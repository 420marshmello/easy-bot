<!DOCTYPE <!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>EasyBot</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<style>
		#last_version {
			color: red;
			text-emphasis: weight;
		}
		</style>
	
	</head>
	<body>
		<center>
			<h1>EasyBot Dashboard</h1>
			<p>Here you can edit your bot information</p>
			<p id="bot_version"></p>
			<p id="last_version"></p>

			<p><a href="https://bigaston.github.io/easy-bot/">Documentation</a> <a href="https://bigaston.github.io/easy-bot/changelog">Changelog</a></p>

			<div id="bot_info"></div>
			<button onclick="openURL()" class="btn btn-primary" id="inviteButton" disabled>Invite to your server</button><br><br>

			<h2>Your code</h2>
			<form action="./update" method="post" id="code_form">
				<textarea class="form-control" id="code" rows="20" name="code"></textarea> <br>
				<button onclick="verifySubmit()" class="btn btn-primary" id="verifyButton">Update</button>
			</form>

			<h2>Your account & Admin</h2>
			<br><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalPassword">
				Change password
			</button>
				
			<div class="modal fade" id="modalPassword" tabindex="-1" role="dialog" aria-labelledby="modalPasswordTitle" aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
						<h5 class="modal-title" id="modalPasswordTitle">Change your password</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
						<div class="modal-body">
							<form action="./editpassword" method="post">		
								<div class="form-group">
									<label for="password-edit">Password</label>
									<input type="password" class="form-control" id="password-edit" placeholder="Password" name="password">
								</div>				
								<button type="submit" class="btn btn-primary">Update</button>
							</form>
						</div>
					</div>
				</div>
			</div>

			<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalAddUser">
				Add User
			</button>
						
			<div class="modal fade" id="modalAddUser" tabindex="-1" role="dialog" aria-labelledby="modalAddUserTitle" aria-hidden="true">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
						<h5 class="modal-title" id="modalAddUserTitle">Add user</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
						</div>
						<div class="modal-body">
							<form action="./newuser" method="post">
								<div class="form-group">
									<label for="name">Username</label>
									<input type="text" class="form-control" id="name" placeholder="Username" name="name">
								</div>
					
								<div class="form-group">
									<label for="password">Password</label>
									<input type="password" class="form-control" id="password" placeholder="Password" name="password">
								</div>				
								<button type="submit" class="btn btn-primary">Submit</button>
							</form>
						</div>
					</div>
				</div>
			</div>
		</center>

		<script>
			bot_id = "";
			version = "";

			function updateBot() {
				fetch("/update_bot");
			}

			function openURL() {
				window.open(`https://discordapp.com/oauth2/authorize?client_id=${bot_id}&scope=bot&permissions=335735808`, target="_blank")
			}
			function verifySubmit() {
				try {
					JSON.parse(document.getElementById("code").value)

					document.getElementById("verifyButton").className("btn btn-primary")
					document.getElementById("code_form").submit();
				} catch(error) {
					console.log(error)
					work = false;
					document.getElementById("verifyButton").className("btn btn-warning")
					
					return;
				}

			}
			fetch('https://raw.githubusercontent.com/Bigaston/easy-bot/master/package.json')
				.then( function (response) {
					if (response.ok)
						return response.json();
					throw new Error("Error on Github version check!");
				})
				.then( function (data) {
					version = data.version
				})
				.catch( function (error) {
					console.log(error.message);
				});
			fetch("/get_code")
				.then( function (response) {
					if (response.ok)
						return response.json();
					throw new Error('Response is not OK');
				})
				.then( function (data) {
					txt_box = document.getElementById("code");
					txt_box.innerHTML = JSON.stringify(data.code, null, 2);
					v = document.getElementById("bot_version")
					v.innerHTML = "Bot version : " + data.version + " - Last version : " + version

					online = version.split(".");
					local = data.version.split(".");

					for (i = 0; i < 3; i++) {
						online[i] = parseInt(online[i]);
						local[i] = parseInt(local[i]);
					}

					if (online[0] > local[0]) {
						p = document.getElementById("last_version")
						p.innerHTML = "You can download a new version on <a href=\"https://github.com/Bigaston/easy-bot\">Github</a>! <br> <button class=\"btn btn-danger\" onclick=\"updateBot()\">Update the bot</button>"
					} else if (online[0] == local[0]) {
						if (online[1] > local[1]) {
							p = document.getElementById("last_version")
							p.innerHTML = "You can download a new version on <a href=\"https://github.com/Bigaston/easy-bot\">Github</a>! <br> <button class=\"btn btn-danger\" onclick=\"updateBot()\">Update the bot</button>"
						} else if (online[1] == local[1]) {
							if (online[2] > local[2]) {
								p = document.getElementById("last_version")
								p.innerHTML = "You can download a new version on <a href=\"https://github.com/Bigaston/easy-bot\">Github</a>! <br> <button class=\"btn btn-danger\" onclick=\"updateBot()\">Update the bot</button>"
							} 
						}
					}

					addBotInfo(data.code);
				})
				.catch( function (error) {
					console.log(error.message);
				});
			function addBotInfo(pCode) {
				header = new Headers({
					"Authorization" : "Bot " + pCode["@token@"] 
				})

				fetch("https://discordapp.com/api/users/@me", {headers: header})
					.then( function(response) {
						if (response.ok)
							return response.json();
						throw new Error('Response is not OK');
					})
					.then( function(data) {
						bot_id = data.id;
						div = document.getElementById("bot_info")
						title = document.createElement("h2")
						title.innerHTML = "Your bot information"
						img = document.createElement("img")
						img.src = `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.png`
						img.alt = "Bot Image"
						p = document.createElement("p")
						p.innerHTML = `${data.username}#${data.discriminator}`

						div.appendChild(title);
						div.appendChild(img);
						div.appendChild(p);

						document.getElementById("inviteButton").disabled = false;

					})
			}
		</script>

		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	</body>
</html>